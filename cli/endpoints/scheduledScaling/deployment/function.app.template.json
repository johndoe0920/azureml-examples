{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "baseName": {
        "defaultValue": "SchduledScaler",
        "type": "string",
        "metadata": {
          "description": "Name use as base-template to named the resources deployed in Azure."
        }
      },
      "appName": {
        "defaultValue": "SchduledScaler",
        "type": "string",
        "metadata": {
          "description": "Name use as base-template to named the resources deployed in Azure."
        }
      },
      "GitHubBranch": {
        "type": "string",
        "defaultValue": "rowagne/create_schedule_scaling",
        "metadata": {
          "description": "Name of the branch to use when deploying (Default = main)."
        }
      },
      "MonitorStorageName": {
        "type": "string",
        "defaultValue": "dropzone",
        "metadata": {
          "description": "Name of the storage account where the files will be drop and unziped. (Default = dropzone)."
        }
      }
    },
    "variables": {
      "funcAppName": "[toLower(concat(parameters('baseName')))]",
      "funcStorageName": "[tolower(concat(substring(parameters('baseName'), 0, min(length(parameters('baseName')),16)), 'stg'))]",
      "serverFarmName": "[concat(substring(parameters('baseName'), 0, min(length(parameters('baseName')),14)), '-srv')]",
      "repoURL": "https://github.com/johndoe0920/azureml-examples.git"
    },
    "resources": [
      {
        "apiVersion": "2018-11-01",
        "type": "Microsoft.Web/sites",
        "name": "[variables('funcAppName')]",
        "location": "[resourceGroup().location]",
        "kind": "functionapp",
        "identity": {
          "type": "SystemAssigned"
        },
        "dependsOn": [
          "[resourceId('Microsoft.Web/serverfarms',variables('serverFarmName'))]",
          "[resourceId('Microsoft.Storage/storageAccounts', variables('funcStorageName'))]"
        ],
        "properties": {
          "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('serverFarmName'))]",
          "siteConfig": {
            "appSettings": [
              // {
              //   "name": "AzureWebJobsDashboard",
              //   "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('funcStorageName'), ';AccountKey=', listKeys(variables('funcStorageName'),'2015-05-01-preview').key1)]"
              // },
              // {
              //   "name": "AzureWebJobsStorage",
              //   "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('funcStorageName'), ';AccountKey=', listKeys(variables('funcStorageName'),'2015-05-01-preview').key1)]"
              // },
              // {
              //   "name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
              //   "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('funcStorageName'), ';AccountKey=', listKeys(variables('funcStorageName'),'2015-05-01-preview').key1)]"
              // },
              // {
              //   "name": "WEBSITE_CONTENTSHARE",
              //   "value": "[variables('funcAppName')]"
              // },
              {
                "name": "FUNCTIONS_EXTENSION_VERSION",
                "value": "~3"
              },
              // {
              //   "name": "FUNCTIONS_WORKER_RUNTIME",
              //   "value": "dotnet"
              // },
              {
                "name": "Project",
                "value": "cli/endpoints/scheduledScaling/"
              }
            ]
          }
        },
        "resources": [
            {
                "apiVersion": "2018-11-01",
                "name": "appsettings",
                "type": "config",
                "dependsOn": [
                  "[resourceId('Microsoft.Web/Sites', variables('funcAppName'))]",
                  "[resourceId('Microsoft.Web/Sites/sourcecontrols', variables('funcAppName'), 'web')]",
                  "[resourceId('Microsoft.Storage/storageAccounts', variables('funcStorageName'))]"
                ],
                "properties": {
                    "AzureWebJobsStorage": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('funcStorageName'), ';AccountKey=', listKeys(variables('funcStorageName'),'2019-06-01').keys[0].value)]",
                    "AzureWebJobsDashboard": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('funcStorageName'), ';AccountKey=', listKeys(variables('funcStorageName'),'2019-06-01').keys[0].value)]",
                    "FUNCTIONS_EXTENSION_VERSION": "~3",
                    "FUNCTIONS_WORKER_RUNTIME": "dotnet",
                    "Project": "cli/endpoints/scheduledScaling/"
                }
            },
            {
              "apiVersion": "2018-11-01",
              "name": "web",
              "type": "sourcecontrols",
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites/', variables('funcAppName'))]"
              ],
              "properties": {
                "RepoUrl": "[variables('repoURL')]",
                "branch": "[parameters('GitHubBranch')]",
                "publishRunbook": true,
                "IsManualIntegration": true
              }
            }
        ]
      },
      {
        "type": "Microsoft.Storage/storageAccounts",
        "apiVersion": "2018-07-01",
        "name": "[variables('funcStorageName')]",
        "location": "[resourceGroup().location]",
        "tags": {
          "displayName": "funStorageName"
        },
        "sku": {
          "name": "Standard_LRS"
        },
        "kind": "StorageV2",
        "resources": [
          {
            "type": "blobServices/containers",
            "apiVersion": "2018-07-01",
            "name": "[concat('default/', 'input-files')]",
            "dependsOn": [
              "[variables('funcStorageName')]"
            ],
            "properties": {
              "publicAccess": "Blob"
            }
          },
          {
            "type": "blobServices/containers",
            "apiVersion": "2018-07-01",
            "name": "[concat('default/', 'schdeuled-scaler')]",
            "dependsOn": [
              "[variables('funcStorageName')]"
            ],
            "properties": {
              "publicAccess": "Blob"
            }
          }
        ]
      },
      {
        "type": "Microsoft.Web/serverfarms",
        "apiVersion": "2018-02-01",
        "name": "[variables('serverFarmName')]",
        "location": "[resourceGroup().location]",
        "sku": {
          "name": "Y1",
          "tier": "Dynamic"
        },
        "properties": {
          "name": "[variables('serverFarmName')]",
          "computeMode": "Dynamic"
        }
      }
      // ,
      // {
      //   "type": "Microsoft.Storage/storageAccounts",
      //   "apiVersion": "2018-07-01",
      //   "name": "[variables('fileStorageName')]",
      //   "location": "[resourceGroup().location]",
      //   "tags": {
      //     "displayName": "[variables('fileStorageName')]"
      //   },
      //   "sku": {
      //     "name": "Standard_LRS"
      //   },
      //   "kind": "StorageV2"
        // "resources": [
        //   {
        //     "type": "blobServices/containers",
        //     "apiVersion": "2018-07-01",
        //     "name": "[concat('default/', 'input-files')]",
        //     "dependsOn": [
        //       "[variables('fileStorageName')]"
        //     ],
        //     "properties": {
        //       "publicAccess": "Blob"
        //     }
        //   },
        //   {
        //     "type": "blobServices/containers",
        //     "apiVersion": "2018-07-01",
        //     "name": "[concat('default/', 'schdeuled-scaler')]",
        //     "dependsOn": [
        //       "[variables('fileStorageName')]"
        //     ],
        //     "properties": {
        //       "publicAccess": "Blob"
        //     }
        //   }
        // ]
      // }
    ],
    "outputs": {}
  }